name: PyPI Release

run-name: 'ci(pypi): release to PyPI'

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Semantic version tag (e.g., 1.2.3)'
        required: true

jobs:
  workflow:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout Codebase
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Setup Python
        run: uv python install 3.13

      - name: Checkout New Release Branch
        run: git checkout -b gh/release-${{ inputs.version }}

      - name: Update Version in pyproject.toml
        run: |
          python -c "
          import re
          with open('pyproject.toml', 'r') as f:
              content = f.read()
          content = re.sub(
              r'(\[project\][^\[]*?)version = \"[^\"]+\"',
              r'\1version = \"${{ inputs.version }}\"',
              content,
              count=1,
              flags=re.DOTALL
          )
          with open('pyproject.toml', 'w') as f:
              f.write(content)
          "

      - name: Commit Version Bump
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add pyproject.toml
          git commit -m 'build: bump version to ${{ inputs.version }}'
          git push origin main

      - name: Push Changes to Release Branch
        run: git push origin gh/release-${{ inputs.version }}

      - name: Create Release
        run: |
          gh release create ${{ inputs.version }} --title 'Release ${{ inputs.version }}' --notes 'Release ${{ inputs.version }}'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Package
        run: uv build

      - name: Publish to PyPI
        run: uv publish --token ${{ secrets.PYPI_TOKEN }}

      - name: Create Pull Request
        run: |
          gh pr create --title 'build: release ${{ inputs.version }}' --body 'Release ${{ inputs.version }}' --base main --head gh/release-${{ inputs.version }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
